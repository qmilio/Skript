--// SERVICES
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--// GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ESP_Menu"
ScreenGui.Parent = CoreGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 220, 0, 130)
Frame.Position = UDim2.new(0.5, -110, 0.5, -65)
Frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
Frame.Parent = ScreenGui

local UICorner = Instance.new("UICorner", Frame)
UICorner.CornerRadius = UDim.new(0, 20)

--// TOGGLE BUTTON
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(1, -20, 0, 45)
ToggleButton.Position = UDim2.new(0, 10, 0, 10)
ToggleButton.Text = "ESP: OFF"
ToggleButton.BackgroundColor3 = Color3.fromRGB(70,70,70)
ToggleButton.TextColor3 = Color3.new(1,1,1)
ToggleButton.TextScaled = true
ToggleButton.Parent = Frame

Instance.new("UICorner", ToggleButton).CornerRadius = UDim.new(0,15)

--// CLOSE BUTTON
local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(1, -20, 0, 45)
CloseButton.Position = UDim2.new(0, 10, 0, 65)
CloseButton.Text = "ЗАВЕРШИТЬ"
CloseButton.BackgroundColor3 = Color3.fromRGB(120,40,40)
CloseButton.TextColor3 = Color3.new(1,1,1)
CloseButton.TextScaled = true
CloseButton.Parent = Frame

Instance.new("UICorner", CloseButton).CornerRadius = UDim.new(0,15)

--// DRAG SYSTEM
local dragging = false
local dragStart
local startPos

Frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = Frame.Position
		
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = input.Position - dragStart
		Frame.Position = UDim2.new(
			startPos.X.Scale,
			startPos.X.Offset + delta.X,
			startPos.Y.Scale,
			startPos.Y.Offset + delta.Y
		)
	end
end)

--// ESP SYSTEM
local espEnabled = false
local highlights = {}
local connections = {}

local function isVisible(character)
	local root = character:FindFirstChild("HumanoidRootPart")
	if not root then return false end
	
	local origin = Camera.CFrame.Position
	local direction = root.Position - origin
	
	local rayParams = RaycastParams.new()
	rayParams.FilterType = Enum.RaycastFilterType.Blacklist
	rayParams.FilterDescendantsInstances = {player.Character}
	rayParams.IgnoreWater = true
	
	local result = workspace:Raycast(origin, direction, rayParams)
	return result and result.Instance:IsDescendantOf(character)
end

local function removeCharacterESP(character)
	if highlights[character] then
		highlights[character]:Destroy()
		highlights[character] = nil
	end
	
	if connections[character] then
		connections[character]:Disconnect()
		connections[character] = nil
	end
end

local function addHighlight(character)
	if not espEnabled then return end
	if highlights[character] then return end
	
	local root = character:WaitForChild("HumanoidRootPart", 5)
	local humanoid = character:WaitForChild("Humanoid", 5)
	if not root or not humanoid then return end
	
	local highlight = Instance.new("Highlight")
	highlight.FillTransparency = 0.5
	highlight.OutlineColor = Color3.new(1,1,1)
	highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	highlight.Parent = character
	
	highlights[character] = highlight
	
	connections[character] = RunService.RenderStepped:Connect(function()
		if not espEnabled then return end
		if humanoid.Health <= 0 then
			removeCharacterESP(character)
			return
		end
		
		if isVisible(character) then
			highlight.FillColor = Color3.fromRGB(0,255,0)
		else
			highlight.FillColor = Color3.fromRGB(255,0,0)
		end
	end)
	
	humanoid.Died:Connect(function()
		removeCharacterESP(character)
	end)
end

local function removeAllESP()
	for character in pairs(highlights) do
		removeCharacterESP(character)
	end
end

local function setupPlayer(plr)
	if plr == player then return end
	
	local function onCharacterAdded(character)
		task.wait(0.2)
		if espEnabled then
			addHighlight(character)
		end
	end
	
	plr.CharacterAdded:Connect(onCharacterAdded)
	
	if plr.Character then
		onCharacterAdded(plr.Character)
	end
end

for _, plr in ipairs(Players:GetPlayers()) do
	setupPlayer(plr)
end

Players.PlayerAdded:Connect(setupPlayer)

--// TOGGLE BUTTON
ToggleButton.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	
	if espEnabled then
		ToggleButton.Text = "ESP: ON"
		for _, plr in ipairs(Players:GetPlayers()) do
			if plr ~= player and plr.Character then
				addHighlight(plr.Character)
			end
		end
	else
		ToggleButton.Text = "ESP: OFF"
		removeAllESP()
	end
end)

--// CLOSE SCRIPT
CloseButton.MouseButton1Click:Connect(function()
	espEnabled = false
	removeAllESP()
	ScreenGui:Destroy()
	script:Destroy()
end)
